varnishtest "Tests command execution timeout"

server s1 {
   rxreq
   txresp
} -repeat 1 -start

varnish v1 -vcl+backend {
    import redis from "${vmod_topbuild}/src/.libs/libvmod_redis.so";

    sub vcl_init {
        new db = redis.db("main", "${redis_master1_address}", 500, 0, 0, 0, 0, false, 1);
    }

    sub vcl_deliver {
        # Fast command (no timeout).
        db.command("SET");
        db.push("foo");
        db.push("hello");
        db.execute();
        set resp.http.Replied-1 = db.replied();
        set resp.http.Reply-1 = db.get_reply();

        # Slow command (no timeout).
        db.command("DEBUG");
        db.push("sleep");
        db.push("3");
        db.execute();
        set resp.http.Replied-2 = db.replied();
        set resp.http.Reply-2 = db.get_reply();

        # Fast command (1000 ms timeout).
        db.command("SET");
        db.push("foo");
        db.push("hello");
        db.timeout(1000);
        db.execute();
        set resp.http.Replied-3 = db.replied();
        set resp.http.Reply-3 = db.get_reply();

        # Slow command (1000 ms timeout).
        db.command("DEBUG");
        db.push("sleep");
        db.push("3");
        db.timeout(1000);
        db.execute();
        set resp.http.Replied-4 = db.replied();
        set resp.http.Reply-4 = db.get_reply();

        # Fast command (no timeout).
        db.command("SET");
        db.push("foo");
        db.push("hello");
        db.execute();
        set resp.http.Replied-5 = db.replied();
        set resp.http.Reply-5 = db.get_reply();

        # Slow command (no timeout).
        db.command("DEBUG");
        db.push("sleep");
        db.push("3");
        db.execute();
        set resp.http.Replied-6 = db.replied();
        set resp.http.Reply-6 = db.get_reply();
    }
} -start

client c1 {
    txreq
    rxresp

    expect resp.http.Replied-1 == "true"
    expect resp.http.Reply-1 == "OK"

    expect resp.http.Replied-2 == "true"
    expect resp.http.Reply-2 == "OK"

    expect resp.http.Replied-3 == "true"
    expect resp.http.Reply-3 == "OK"

    expect resp.http.Replied-4 == "false"
    expect resp.http.Reply-4 == ""

    expect resp.http.Replied-5 == "true"
    expect resp.http.Reply-5 == "OK"

    expect resp.http.Replied-6 == "true"
    expect resp.http.Reply-6 == "OK"
} -run

varnish v1 -expect client_req == 1
