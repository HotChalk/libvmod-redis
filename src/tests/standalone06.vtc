varnishtest "Test VCL temperature & discard."

server s1 {
   rxreq
   txresp
} -repeat 1 -start

varnish v1 -vcl+backend {
    import redis from "${vmod_topbuild}/src/.libs/libvmod_redis.so";

    sub vcl_init {
        new db1 = redis.db("${redis_master1_address}", 500, 0, 0, 0, false, 1, false, 0);
        new db2 = redis.db("${redis_master2_address}", 500, 0, 0, 0, true, 32, false, 0);
    }
} -start

varnish v1 -vcl+backend {
}

varnish v1 -cliok "vcl.state vcl1 cold"

varnish v1 -cliok "vcl.use vcl1"

varnish v1 -cliok "vcl.use vcl2"

varnish v1 -cliok "vcl.discard vcl1"

varnish v1 -expect MGT.child_panic == 0
